name: ex-post-failure-report

on:
  workflow_dispatch:
    inputs:
      worlds:
        description: "Comma-separated world ids (empty = all worlds)"
        required: false
        default: ""
      stage:
        description: "EvaluationRun stage filter (default=live)"
        required: false
        default: "live"
      months:
        description: "Lookback window in months (approx; default=12)"
        required: false
        default: "12"
  schedule:
    - cron: "11 3 1 * *" # Monthly on day 1 at 03:11 UTC

permissions:
  contents: read

jobs:
  report:
    runs-on: ubuntu-latest
    env:
      WORLDS_DB_DSN: ${{ secrets.WORLDS_DB_DSN }}
      WORLDS_REDIS_DSN: ${{ secrets.WORLDS_REDIS_DSN }}
    steps:
      - uses: actions/checkout@v4

      - name: Skip if secrets missing
        if: ${{ env.WORLDS_DB_DSN == '' || env.WORLDS_REDIS_DSN == '' }}
        run: |
          echo "Missing WORLDS_DB_DSN/WORLDS_REDIS_DSN secrets; skipping ex-post failure report."
          exit 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Generate ex-post failure report
        shell: bash
        run: |
          set -euo pipefail
          stage="${{ inputs.stage || 'live' }}"
          months="${{ inputs.months || '12' }}"
          worlds="${{ inputs.worlds || '' }}"
          args=(--stage "$stage" --months "$months")
          if [[ -n "$worlds" ]]; then
            IFS=',' read -r -a world_list <<< "$worlds"
            for w in "${world_list[@]}"; do
              w_trim="$(echo "$w" | xargs)"
              if [[ -n "$w_trim" ]]; then
                args+=(--world "$w_trim")
              fi
            done
          fi
          uv run python scripts/generate_ex_post_failure_report.py "${args[@]}" --format md --output ex_post_failure_report.md
          uv run python scripts/generate_ex_post_failure_report.py "${args[@]}" --format json --output ex_post_failure_report.json

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: ex-post-failure-report
          path: |
            ex_post_failure_report.md
            ex_post_failure_report.json

