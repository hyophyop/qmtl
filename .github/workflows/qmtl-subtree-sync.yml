name: Sync QMTL Subtree

on:
  schedule:
    - cron: "0 2 * * MON"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    if: github.repository == 'hyophyop/qmtl-strategies'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Record starting point
        id: start
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Ensure qmtl-subtree remote
        run: |
          if ! git remote get-url qmtl-subtree >/dev/null 2>&1; then
            git remote add qmtl-subtree https://github.com/hyophyop/qmtl.git
          fi

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync qmtl subtree
        run: scripts/sync_qmtl.sh

      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet "${{ steps.start.outputs.sha }}" HEAD; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare changes for PR
        if: steps.diff.outputs.changed == 'true'
        run: git reset --mixed "${{ steps.start.outputs.sha }}"

      - name: Snapshot diff
        if: steps.diff.outputs.changed == 'true'
        id: patch
        run: |
          PATCH_FILE="$RUNNER_TEMP/qmtl-sync.patch"
          git diff --binary > "$PATCH_FILE"
          echo "path=$PATCH_FILE" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: steps.diff.outputs.changed == 'true'
        id: cpr
        continue-on-error: true
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/qmtl-subtree-sync
          delete-branch: true
          commit-message: "chore: sync qmtl subtree"
          title: "chore: sync qmtl subtree"
          body: |
            Automated sync of the `qmtl/` subtree via `scripts/sync_qmtl.sh`.
            Review upstream changes and merge when ready.

      - name: PR summary
        if: steps.diff.outputs.changed == 'true' && steps.cpr.outcome == 'success'
        run: |
          echo "Opened PR #${{ steps.cpr.outputs.pull-request-number }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Push fallback branch
        if: steps.diff.outputs.changed == 'true' && steps.cpr.outcome == 'failure'
        id: fallback
        env:
          SYNC_BRANCH: chore/qmtl-subtree-sync
          PATCH_FILE: ${{ steps.patch.outputs.path }}
        run: |
          pushed=false
          if [ -n "$PATCH_FILE" ] && [ -s "$PATCH_FILE" ]; then
            git apply "$PATCH_FILE"
            git branch -D "$SYNC_BRANCH" 2>/dev/null || true
            git switch -c "$SYNC_BRANCH"
            git add -A
            git commit -m "chore: sync qmtl subtree"
            git push --force-with-lease origin "$SYNC_BRANCH"
            pushed=true
          else
            echo "No subtree changes were detected after reset; skipping push." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "pushed=$pushed" >> "$GITHUB_OUTPUT"

      - name: Fallback summary
        if: steps.diff.outputs.changed == 'true' && steps.cpr.outcome == 'failure' && steps.fallback.outputs.pushed == 'true'
        env:
          SYNC_BRANCH: chore/qmtl-subtree-sync
          REPO: ${{ github.repository }}
        run: |
          echo "GitHub Actions could not open a PR automatically. Branch $SYNC_BRANCH was pushed instead. Please open a PR manually." >> "$GITHUB_STEP_SUMMARY"
          echo "https://github.com/$REPO/tree/$SYNC_BRANCH" >> "$GITHUB_STEP_SUMMARY"

      - name: No changes summary
        if: steps.diff.outputs.changed != 'true'
        run: echo "qmtl subtree already up to date." >> "$GITHUB_STEP_SUMMARY"
