name: validation-slo-report

on:
  workflow_dispatch:
    inputs:
      worlds:
        description: "Comma-separated world ids (empty = all worlds)"
        required: false
        default: ""
      stages:
        description: "Comma-separated stages (empty = all stages)"
        required: false
        default: ""
      months:
        description: "Lookback window in months (approx; default=1)"
        required: false
        default: "1"
      coverage_p95_min:
        description: "Gate: p95(metric_coverage_ratio) >= threshold"
        required: false
        default: "0.98"
      rules_executed_p95_min:
        description: "Gate: p95(rules_executed_ratio) >= threshold"
        required: false
        default: "1.0"
      missing_metric_run_ratio_max:
        description: "Gate: missing_metric run ratio <= threshold"
        required: false
        default: "0.01"
      rule_error_run_ratio_max:
        description: "Gate: rule_error run ratio <= threshold"
        required: false
        default: "0.01"

permissions:
  contents: read

jobs:
  report:
    runs-on: ubuntu-latest
    env:
      WORLDS_DB_DSN: ${{ secrets.WORLDS_DB_DSN }}
      WORLDS_REDIS_DSN: ${{ secrets.WORLDS_REDIS_DSN }}
    steps:
      - uses: actions/checkout@v4

      - name: Skip if secrets missing
        if: ${{ env.WORLDS_DB_DSN == '' || env.WORLDS_REDIS_DSN == '' }}
        run: |
          echo "Missing WORLDS_DB_DSN/WORLDS_REDIS_DSN secrets; skipping validation SLO report."
          exit 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Generate report (md/json)
        shell: bash
        run: |
          set -euo pipefail
          worlds="${{ inputs.worlds || '' }}"
          stages="${{ inputs.stages || '' }}"
          months="${{ inputs.months || '1' }}"
          cov_p95="${{ inputs.coverage_p95_min || '0.98' }}"
          rules_p95="${{ inputs.rules_executed_p95_min || '1.0' }}"
          miss_max="${{ inputs.missing_metric_run_ratio_max || '0.01' }}"
          err_max="${{ inputs.rule_error_run_ratio_max || '0.01' }}"

          args=(--months "$months" --coverage-p95-min "$cov_p95" --rules-executed-p95-min "$rules_p95" --missing-metric-run-ratio-max "$miss_max" --rule-error-run-ratio-max "$err_max")
          if [[ -n "$worlds" ]]; then
            IFS=',' read -r -a world_list <<< "$worlds"
            for w in "${world_list[@]}"; do
              w_trim="$(echo "$w" | xargs)"
              if [[ -n "$w_trim" ]]; then
                args+=(--world "$w_trim")
              fi
            done
          fi
          if [[ -n "$stages" ]]; then
            IFS=',' read -r -a stage_list <<< "$stages"
            for s in "${stage_list[@]}"; do
              s_trim="$(echo "$s" | xargs)"
              if [[ -n "$s_trim" ]]; then
                args+=(--stage "$s_trim")
              fi
            done
          fi

          uv run python scripts/report_validation_slo.py "${args[@]}" --format json --output validation_slo_report.json
          uv run python scripts/report_validation_slo.py "${args[@]}" --format md --output validation_slo_report.md

      - name: Gate (fail on breach)
        shell: bash
        run: |
          set -euo pipefail
          worlds="${{ inputs.worlds || '' }}"
          stages="${{ inputs.stages || '' }}"
          months="${{ inputs.months || '1' }}"
          cov_p95="${{ inputs.coverage_p95_min || '0.98' }}"
          rules_p95="${{ inputs.rules_executed_p95_min || '1.0' }}"
          miss_max="${{ inputs.missing_metric_run_ratio_max || '0.01' }}"
          err_max="${{ inputs.rule_error_run_ratio_max || '0.01' }}"

          args=(--months "$months" --coverage-p95-min "$cov_p95" --rules-executed-p95-min "$rules_p95" --missing-metric-run-ratio-max "$miss_max" --rule-error-run-ratio-max "$err_max")
          if [[ -n "$worlds" ]]; then
            IFS=',' read -r -a world_list <<< "$worlds"
            for w in "${world_list[@]}"; do
              w_trim="$(echo "$w" | xargs)"
              if [[ -n "$w_trim" ]]; then
                args+=(--world "$w_trim")
              fi
            done
          fi
          if [[ -n "$stages" ]]; then
            IFS=',' read -r -a stage_list <<< "$stages"
            for s in "${stage_list[@]}"; do
              s_trim="$(echo "$s" | xargs)"
              if [[ -n "$s_trim" ]]; then
                args+=(--stage "$s_trim")
              fi
            done
          fi

          uv run python scripts/report_validation_slo.py "${args[@]}" --format json --output validation_slo_report.json --fail

      - name: Upload report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: validation-slo-report
          path: |
            validation_slo_report.md
            validation_slo_report.json
