name: override-rereview-queue

on:
  workflow_dispatch:
    inputs:
      worlds:
        description: "Comma-separated world ids (empty = all worlds)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  queue:
    runs-on: ubuntu-latest
    env:
      WORLDS_DB_DSN: ${{ secrets.WORLDS_DB_DSN }}
      WORLDS_REDIS_DSN: ${{ secrets.WORLDS_REDIS_DSN }}
    steps:
      - uses: actions/checkout@v4

      - name: Skip if secrets missing
        if: ${{ env.WORLDS_DB_DSN == '' || env.WORLDS_REDIS_DSN == '' }}
        run: |
          echo "Missing WORLDS_DB_DSN/WORLDS_REDIS_DSN secrets; skipping override re-review job."
          exit 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Generate override re-review queue
        shell: bash
        run: |
          set -euo pipefail
          worlds="${{ inputs.worlds || '' }}"
          args=()
          if [[ -n "$worlds" ]]; then
            IFS=',' read -r -a world_list <<< "$worlds"
            for w in "${world_list[@]}"; do
              w_trim="$(echo "$w" | xargs)"
              if [[ -n "$w_trim" ]]; then
                args+=(--world "$w_trim")
              fi
            done
          fi
          uv run python scripts/generate_override_rereview_report.py "${args[@]}" --format md --output override_queue.md
          uv run python scripts/generate_override_rereview_report.py "${args[@]}" --format json --output override_queue.json

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: override-rereview-queue
          path: |
            override_queue.md
            override_queue.json
