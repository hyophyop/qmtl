name: evaluation-store-retention

on:
  workflow_dispatch:
    inputs:
      retention_days:
        description: "History retention window in days"
        required: false
        default: "180"
      dry_run:
        description: "If true, do not delete rows"
        required: false
        default: "true"
  schedule:
    - cron: "17 3 * * 1" # Mondays 03:17 UTC

permissions:
  contents: read

jobs:
  purge:
    runs-on: ubuntu-latest
    env:
      WORLDS_DB_DSN: ${{ secrets.WORLDS_DB_DSN }}
      WORLDS_REDIS_DSN: ${{ secrets.WORLDS_REDIS_DSN }}
    steps:
      - uses: actions/checkout@v4

      - name: Skip if secrets missing
        if: ${{ env.WORLDS_DB_DSN == '' || env.WORLDS_REDIS_DSN == '' }}
        run: |
          echo "Missing WORLDS_DB_DSN/WORLDS_REDIS_DSN secrets; skipping retention job."
          exit 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Run purge (dry-run by default)
        run: |
          retention_days="${{ inputs.retention_days || '180' }}"
          dry_run="${{ inputs.dry_run || 'true' }}"
          args=(--retention-days "$retention_days" --output purge_report.json)
          if [[ "$dry_run" == "true" ]]; then
            :
          else
            args+=(--execute)
          fi
          uv run python scripts/purge_evaluation_run_history.py "${args[@]}"

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: purge_report
          path: purge_report.json

