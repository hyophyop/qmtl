
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="QMTL Team">
      
      
      
        <link rel="prev" href="../glossary/">
      
      
        <link rel="next" href="../gateway/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>QMTL DAG Manager — 상세 설계서 (Extended Edition) - QMTL Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#qmtl-dag-manager-extended-edition" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="QMTL Documentation" class="md-header__button md-logo" aria-label="QMTL Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            QMTL Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              QMTL DAG Manager — 상세 설계서 (Extended Edition)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="QMTL Documentation" class="md-nav__button md-logo" aria-label="QMTL Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    QMTL Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../MAINTENANCE_SCHEDULE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Maintenance Schedule
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture & Ownership
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    DAG Manager
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    DAG Manager
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      관련 문서
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      0. 역할 요약 &amp; 설계 철학
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0-a-ownership-commit-log-design" class="md-nav__link">
    <span class="md-ellipsis">
      0-A. Ownership &amp; Commit-Log Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0-A. Ownership &amp; Commit-Log Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0-a1-commit-log-message-keys-and-partitioning" class="md-nav__link">
    <span class="md-ellipsis">
      0-A.1 Commit-Log Message Keys and Partitioning
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-neo4j-property-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. 데이터 모델 (Neo4j Property Graph)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 데이터 모델 (Neo4j Property Graph)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 노드·관계 스키마
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 인덱스 &amp; 제약 조건
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-nodeid-generation" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 NodeID Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-diff-v2" class="md-nav__link">
    <span class="md-ellipsis">
      2. Diff 알고리즘 (v2)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Diff 알고리즘 (v2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 입력·출력 정의
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 단계별 상세 로직
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 알고리즘 복잡도
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2a-gateway-dag-manager-interface" class="md-nav__link">
    <span class="md-ellipsis">
      2‑A. Gateway ↔ DAG Manager Interface (확장)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-b-sentinel-traffic-api" class="md-nav__link">
    <span class="md-ellipsis">
      2-B. Sentinel Traffic API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#callbackssentinel-traffic-versionsentinel-version-v120-weight-025-neo4j-traffic_weight-sentinel_weight-cloudevent-gateway-prometheus-dagmanager_active_version_weightversionid" class="md-nav__link">
    <span class="md-ellipsis">
      /callbacks/sentinel-traffic는 특정 VersionSentinel의 트래픽 가중치를 업데이트한다. 요청 본문은 {"version": "v1.2.0", "weight": 0.25} 형식이다. 수신 시 메모리 맵과 Neo4j 노드의 traffic_weight 속성에 값을 저장하고, 변경 사실을 sentinel_weight CloudEvent로 Gateway에 전달한다. 현재 적용된 값은 Prometheus 게이지 dagmanager_active_version_weight{version="&lt;id&gt;"}로 노출된다.
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 토픽 생성 &amp; 명명 규칙 (확장)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 토픽 생성 &amp; 명명 규칙 (확장)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 토픽 이름 컨벤션
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-qos" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 QoS &amp; 레플리카 설정
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3a-endtoend-interaction-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      3‑A. End‑to‑End Interaction Scenarios (확장)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3b-control-events-queueupdated-new" class="md-nav__link">
    <span class="md-ellipsis">
      3‑B. Control Events (QueueUpdated) (New)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-garbage-collection-orphan-queue-gc" class="md-nav__link">
    <span class="md-ellipsis">
      4. Garbage Collection (Orphan Queue GC) (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 장애 시나리오 &amp; 복구 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 관측 &amp; 메트릭 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      7. 보안 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 잠재 취약점 &amp; 완화 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-service-level-objectives-slo" class="md-nav__link">
    <span class="md-ellipsis">
      9. Service Level Objectives (SLO)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-testing-validation" class="md-nav__link">
    <span class="md-ellipsis">
      10. Testing &amp; Validation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-admin-cli-snippets" class="md-nav__link">
    <span class="md-ellipsis">
      11. Admin CLI Snippets (예)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12_1" class="md-nav__link">
    <span class="md-ellipsis">
      12. 서버 설정 파일 사용법
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gateway
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../worldservice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    World Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../controlbus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ControlBus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lean_brokerage_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lean Brokerage Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/brokerage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Brokerage API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../implementation_todos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Implementation TODOs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/sdk_tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SDK Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/strategy_workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategy Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/backfill/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backfill
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/canary_rollout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Canary Rollout
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/e2e_testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    E2E Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/activation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    World Activation Runbook
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/risk_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Risk Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/timing_controls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Timing Controls
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/release/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Schemas
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Templates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api_world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    World API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/enhanced_validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enhanced Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/backtest_validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backtest Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/lean_like_features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lean-like Features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/brokerage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Brokerage API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/CHANGELOG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    World
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            World
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../world/world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spec
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../world/realm_rename_eval/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Realm Terminology Evaluation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../templates/template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Template
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      관련 문서
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      0. 역할 요약 &amp; 설계 철학
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0-a-ownership-commit-log-design" class="md-nav__link">
    <span class="md-ellipsis">
      0-A. Ownership &amp; Commit-Log Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0-A. Ownership &amp; Commit-Log Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0-a1-commit-log-message-keys-and-partitioning" class="md-nav__link">
    <span class="md-ellipsis">
      0-A.1 Commit-Log Message Keys and Partitioning
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-neo4j-property-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. 데이터 모델 (Neo4j Property Graph)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 데이터 모델 (Neo4j Property Graph)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 노드·관계 스키마
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 인덱스 &amp; 제약 조건
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-nodeid-generation" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 NodeID Generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-diff-v2" class="md-nav__link">
    <span class="md-ellipsis">
      2. Diff 알고리즘 (v2)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Diff 알고리즘 (v2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 입력·출력 정의
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 단계별 상세 로직
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 알고리즘 복잡도
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2a-gateway-dag-manager-interface" class="md-nav__link">
    <span class="md-ellipsis">
      2‑A. Gateway ↔ DAG Manager Interface (확장)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-b-sentinel-traffic-api" class="md-nav__link">
    <span class="md-ellipsis">
      2-B. Sentinel Traffic API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#callbackssentinel-traffic-versionsentinel-version-v120-weight-025-neo4j-traffic_weight-sentinel_weight-cloudevent-gateway-prometheus-dagmanager_active_version_weightversionid" class="md-nav__link">
    <span class="md-ellipsis">
      /callbacks/sentinel-traffic는 특정 VersionSentinel의 트래픽 가중치를 업데이트한다. 요청 본문은 {"version": "v1.2.0", "weight": 0.25} 형식이다. 수신 시 메모리 맵과 Neo4j 노드의 traffic_weight 속성에 값을 저장하고, 변경 사실을 sentinel_weight CloudEvent로 Gateway에 전달한다. 현재 적용된 값은 Prometheus 게이지 dagmanager_active_version_weight{version="&lt;id&gt;"}로 노출된다.
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 토픽 생성 &amp; 명명 규칙 (확장)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 토픽 생성 &amp; 명명 규칙 (확장)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 토픽 이름 컨벤션
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-qos" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 QoS &amp; 레플리카 설정
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3a-endtoend-interaction-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      3‑A. End‑to‑End Interaction Scenarios (확장)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3b-control-events-queueupdated-new" class="md-nav__link">
    <span class="md-ellipsis">
      3‑B. Control Events (QueueUpdated) (New)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-garbage-collection-orphan-queue-gc" class="md-nav__link">
    <span class="md-ellipsis">
      4. Garbage Collection (Orphan Queue GC) (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 장애 시나리오 &amp; 복구 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 관측 &amp; 메트릭 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      7. 보안 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 잠재 취약점 &amp; 완화 (확장)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-service-level-objectives-slo" class="md-nav__link">
    <span class="md-ellipsis">
      9. Service Level Objectives (SLO)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-testing-validation" class="md-nav__link">
    <span class="md-ellipsis">
      10. Testing &amp; Validation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-admin-cli-snippets" class="md-nav__link">
    <span class="md-ellipsis">
      11. Admin CLI Snippets (예)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12_1" class="md-nav__link">
    <span class="md-ellipsis">
      12. 서버 설정 파일 사용법
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<p><a href="/">Home</a> / <a href="/architecture">architecture</a> / <a href="/architecture/dag-manager">dag-manager</a>
<strong>Related:</strong> <a href="../">Overview</a>, <a href="../architecture/">Architecture &amp; Ownership</a>, <a href="../glossary/">Glossary</a>, <a href="./">DAG Manager</a>, <a href="../gateway/">Gateway</a>, <a href="../worldservice/">World Service</a>, <a href="../controlbus/">ControlBus</a>, <a href="../lean_brokerage_model/">Lean Brokerage Model</a>, <a href="../../reference/api/brokerage/">Brokerage API</a>, <a href="../implementation_todos/">Implementation TODOs</a></p>
<h1 id="qmtl-dag-manager-extended-edition">QMTL DAG Manager — 상세 설계서 (Extended Edition)</h1>
<blockquote>
<p><strong>Revision 2025‑06‑04 / v1.1</strong>  — 문서 분량 +75% 확장, 실전 운영 기준 세부 스펙 포함</p>
</blockquote>
<h2 id="_1">관련 문서</h2>
<ul>
<li><a href="../">Architecture Overview</a></li>
<li><a href="../architecture/">QMTL Architecture</a></li>
<li><a href="../gateway/">Gateway</a></li>
<li><a href="../lean_brokerage_model/">Lean Brokerage Model</a></li>
</ul>
<hr />
<h2 id="0">0. 역할 요약 &amp; 설계 철학</h2>
<table>
<thead>
<tr>
<th>핵심 책임</th>
<th>세부 설명</th>
<th>관련 섹션</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Graph DB Single Source of Truth</strong></td>
<td>Neo4j Property Graph → 모든 전략 노드·토픽·버전 메타가 단일 그래프에 영속</td>
<td>§1 데이터 모델</td>
</tr>
<tr>
<td><strong>DAG Diff 엔진</strong></td>
<td>제출 DAG와 Neo4j 그래프 간 구조·해시 비교 → 재사용/신규 노드 판정·토픽 매핑</td>
<td>§2 Diff 알고리즘</td>
</tr>
<tr>
<td><strong>토픽 오케스트레이션</strong></td>
<td>Idempotent 토픽 생성·TTL·GC·버전 롤아웃, ref‑count 기반 제거</td>
<td>§3, §4</td>
</tr>
<tr>
<td><strong>버전 관리·롤백</strong></td>
<td>Version Sentinel 노드로 그래프 버전 경계 표시 → 카나리아 트래픽 스플릿·롤백 </td>
<td>§2, §3‑A</td>
</tr>
<tr>
<td><strong>SRE Friendly</strong></td>
<td>gRPC/HTTP 인터페이스, 메트릭·로그·Alert 통합, Admin CLI</td>
<td>§6, §10</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>설계 철학:</strong> “계산 그래프 + 메시징 큐”를 <strong>불변 ID</strong>로 연결해 재현성·롤백 가능성을 최우선. 모든 변형은 새 노드·토픽으로 분기하고, 레거시는 TTL+GC로 안전 제거.
SDK 측에서 실행되는 모든 <code>compute_fn</code>은 <code>NodeCache.view()</code>가 반환하는 read-only <code>CacheView</code> 한 개만을 인자로 받는다.</p>
</blockquote>
<hr />
<h2 id="0-a-ownership-commit-log-design">0-A. Ownership &amp; Commit-Log Design</h2>
<ul>
<li><strong>Ownership</strong> — DAG Manager는 ComputeNode와 Queue 메타데이터의 단일 소스로서 토픽 생성·버전 롤아웃·GC를 전담한다. Gateway는 제출 파이프라인을 조정하지만 그래프 상태를 소유하지 않으며, WorldService는 월드·결정 상태를 유지한다.</li>
<li><strong>Commit Log</strong> — 모든 큐는 Redpanda/Kafka의 append-only 토픽으로 구현되며, DAG Manager는 <code>QueueUpdated</code> 등 제어 이벤트를 ControlBus 토픽에 발행한다. 토픽 생성·삭제 이력도 관리 로그에 기록되어 장애 시점 복원과 감사(audit)을 지원한다.</li>
</ul>
<h3 id="0-a1-commit-log-message-keys-and-partitioning">0-A.1 Commit-Log Message Keys and Partitioning</h3>
<ul>
<li>Partitioning key derives from <code>partition_key(node_id, interval, bucket_ts)</code>; the full Kafka message key used by Gateway is:</li>
</ul>
<p><code>"{partition_key(node_id, interval, bucket_ts)}:{input_window_hash}"</code></p>
<p>This allows log compaction across all input windows for the same execution key while keeping per‑window uniqueness.</p>
<ul>
<li>Consumers must deduplicate based on <code>(node_id, bucket_ts, input_window_hash)</code>.</li>
</ul>
<hr />
<h2 id="1-neo4j-property-graph">1. 데이터 모델 (Neo4j Property Graph)</h2>
<h3 id="11">1.1 노드·관계 스키마</h3>
<table>
<thead>
<tr>
<th>Label</th>
<th>필수 속성</th>
<th>선택 속성</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ComputeNode</code></td>
<td><code>node_id</code>(pk), <code>interval</code>, <code>period</code>, <code>code_hash</code>, <code>schema_hash</code>, <code>schema_id</code></td>
<td><code>created_at</code>, <code>tags[]</code>, <code>owner</code></td>
<td>DAG 연산 노드 (지표·전처리·매매 등)</td>
</tr>
<tr>
<td><code>Queue</code></td>
<td><code>topic</code>, <code>created_at</code>, <code>ttl</code>, <code>retention_ms</code></td>
<td><code>brokers</code>, <code>tag</code>, <code>lag_alert_threshold</code></td>
<td>Kafka/Redpanda 토픽</td>
</tr>
<tr>
<td><code>VersionSentinel</code></td>
<td><code>version</code>, <code>commit_hash</code>, <code>created_at</code></td>
<td><code>release_tag</code>, <code>traffic_weight</code></td>
<td>버전 경계 · 롤백 포인트</td>
</tr>
<tr>
<td><code>Artifact</code></td>
<td><code>path</code>, <code>checksum</code>, <code>size</code></td>
<td><code>framework</code>, <code>dtype</code></td>
<td>모델·파라미터 파일 등 binary</td>
</tr>
</tbody>
</table>
<p><strong>Relationships</strong></p>
<pre><code>(ComputeNode)-[:EMITS]-&gt;(Queue)
(VersionSentinel)-[:HAS]-&gt;(ComputeNode)
(Artifact)-[:USED_BY]-&gt;(ComputeNode)
</code></pre>
<h3 id="12">1.2 인덱스 &amp; 제약 조건</h3>
<pre><code class="language-cypher">CREATE CONSTRAINT compute_pk IF NOT EXISTS
ON (c:ComputeNode) ASSERT c.node_id IS UNIQUE;
CREATE INDEX kafka_topic IF NOT EXISTS FOR (q:Queue) ON (q.topic);
</code></pre>
<h3 id="13-nodeid-generation">1.3 NodeID Generation</h3>
<ul>
<li>NodeID = SHA-256 hash of <code>(node_type, code_hash, config_hash, schema_hash)</code>.</li>
<li>On collision detection the hash upgrades to SHA-3.</li>
<li>Uniqueness enforced via <code>compute_pk</code> constraint.</li>
<li><code>schema_id</code> references the Schema Registry entry for the node's message format.</li>
</ul>
<hr />
<h2 id="2-diff-v2">2. Diff 알고리즘 (v2)</h2>
<h3 id="21">2.1 입력·출력 정의</h3>
<ul>
<li><strong>Input:</strong> <code>DiffReq{strategy_id, dag_json}</code> (\~10‑500 KiB)</li>
<li><strong>Output:</strong> stream <code>DiffChunk{queue_map[], sentinel_id}</code></li>
</ul>
<h3 id="22">2.2 단계별 상세 로직</h3>
<ol>
<li>
<p><strong>Node Pre‑scan</strong> O(N) </p>
</li>
<li>
<p>파이썬 <code>orjson</code> → DAG dict → topo sort → node_id list.</p>
</li>
<li><strong>DB Fetch</strong> Batch <code>MATCH (c:ComputeNode WHERE c.node_id IN $list)</code> → 기존 노드 맵.</li>
<li><strong>Hash Compare</strong></li>
</ol>
<table>
<thead>
<tr>
<th>케이스</th>
<th>처리</th>
<th>큐 정책</th>
</tr>
</thead>
<tbody>
<tr>
<td>code_hash &amp; schema_hash 완전 동일</td>
<td><strong>재사용</strong></td>
<td>기존 Queue join</td>
</tr>
<tr>
<td>Back‑compat 스키마 변경</td>
<td><strong>재사용 + 버퍼링 모드</strong></td>
<td>큐 lag = history size, 7일 이후 자동 full‑recompute</td>
</tr>
<tr>
<td>Breaking 스키마 or code 변경</td>
<td><strong>신규 노드·큐</strong></td>
<td><code>topic_suffix=_v{n}</code>, TTL inherit</td>
</tr>
<tr>
<td>4. <strong>Sentinel 삽입</strong> <code>CREATE (:VersionSentinel{...})‑[:HAS]-&gt;(new_nodes)</code> (옵션)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5. <strong>Queue Upsert</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Kafka Admin API must run with idempotent topic creation enabled as noted in the architecture (section 2).</li>
<li>gRPC Bulk <code>CreateTopicsRequest</code> idempotent.</li>
<li>실패 시 <code>CREATE_TOPICS→VERIFY→WAIT→BACKOFF</code> 5단계 재시도를 수행하고,
     VERIFY 단계에서 broker metadata를 조회하여 유사 이름 충돌 여부를 확인한다.</li>
<li><strong>Stream 전송</strong> 100 items/≤1 MiB chunk + ACK window(10).</li>
</ul>
<h3 id="23">2.3 알고리즘 복잡도</h3>
<ul>
<li>그래프 인덱스 hit → O(N) </li>
<li>Network Δ ≈ (#chunks × rtt)</li>
<li>1k 노드 기준 p95 &lt; 80 ms (λ=50 req/s 시험 환경)</li>
</ul>
<hr />
<h3 id="2a-gateway-dag-manager-interface">2‑A. Gateway ↔ DAG Manager Interface (확장)</h3>
<table>
<thead>
<tr>
<th>방향</th>
<th>Proto</th>
<th>Endpoint</th>
<th>Payload</th>
<th>응답</th>
<th>Retry/Timeout</th>
<th>목적</th>
</tr>
</thead>
<tbody>
<tr>
<td>G→D</td>
<td>gRPC</td>
<td><code>DiffService.DiffRequest</code></td>
<td>DAG</td>
<td><code>DiffChunk stream</code></td>
<td>backoff 0.5→4 s ×5</td>
<td>Diff &amp; 토픽 매핑</td>
</tr>
<tr>
<td>D→G</td>
<td>HTTP</td>
<td><code>/callbacks/dag-event</code></td>
<td>queue_added/gc</td>
<td>202</td>
<td>backoff 1→8 s ×3</td>
<td>큐 이벤트</td>
</tr>
<tr>
<td>G→D</td>
<td>gRPC</td>
<td><code>AdminService.Cleanup</code></td>
<td>strategy_id</td>
<td>Ack</td>
<td>1 retry</td>
<td>ref‑count decref</td>
</tr>
<tr>
<td>G→D</td>
<td>gRPC</td>
<td><code>AdminService.GetQueueStats</code></td>
<td>filter</td>
<td>Stats</td>
<td>300 ms</td>
<td>모니터링</td>
</tr>
<tr>
<td>G→D</td>
<td>gRPC</td>
<td><code>HealthCheck.Ping</code></td>
<td>–</td>
<td>Pong</td>
<td>30 s interval</td>
<td>Liveness</td>
</tr>
<tr>
<td>G→D</td>
<td>HTTP</td>
<td><code>/admin/gc-trigger</code></td>
<td>id</td>
<td>202</td>
<td>2 retry</td>
<td>Manual GC</td>
</tr>
<tr>
<td>G→D</td>
<td>gRPC</td>
<td><code>AdminService.RedoDiff</code></td>
<td>sentinel_id</td>
<td>DiffResult</td>
<td>manual</td>
<td>재Diff·롤백</td>
</tr>
<tr>
<td>D→G</td>
<td>HTTP</td>
<td><code>/callbacks/sentinel-traffic</code></td>
<td>version, weight</td>
<td>202</td>
<td>3×</td>
<td>카나리아 비율 변경</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>자세한 절차는 <a href="../../operations/canary_rollout/">Canary Rollout Guide</a> 참조</td>
</tr>
</tbody>
</table>
<h3 id="2-b-sentinel-traffic-api">2-B. Sentinel Traffic API</h3>
<h2 id="callbackssentinel-traffic-versionsentinel-version-v120-weight-025-neo4j-traffic_weight-sentinel_weight-cloudevent-gateway-prometheus-dagmanager_active_version_weightversionid"><code>/callbacks/sentinel-traffic</code>는 특정 <code>VersionSentinel</code>의 트래픽 가중치를 업데이트한다. 요청 본문은 <code>{"version": "v1.2.0", "weight": 0.25}</code> 형식이다. 수신 시 메모리 맵과 Neo4j 노드의 <code>traffic_weight</code> 속성에 값을 저장하고, 변경 사실을 <code>sentinel_weight</code> CloudEvent로 Gateway에 전달한다. 현재 적용된 값은 Prometheus 게이지 <code>dagmanager_active_version_weight{version="&lt;id&gt;"}</code>로 노출된다.</h2>
<h2 id="3">3. 토픽 생성 &amp; 명명 규칙 (확장)</h2>
<h3 id="31">3.1 토픽 이름 컨벤션</h3>
<pre><code>{asset}_{node_type}_{short_hash}_{version}{_dry_run?}
</code></pre>
<ul>
<li><strong>dry_run</strong> 플래그가 붙으면 <code>*_sim</code> 접미사.</li>
<li><code>short_hash = first 6 code_hash</code> → 충돌 시 길이+2.</li>
<li>기본 토픽 설정은 코드의 <code>_TOPIC_CONFIG</code> 에서 관리되며 <code>get_config(topic_type)</code> 으로 조회한다.</li>
</ul>
<h3 id="32-qos">3.2 QoS &amp; 레플리카 설정</h3>
<table>
<thead>
<tr>
<th>토픽 타입</th>
<th>partitions</th>
<th>rep_factor</th>
<th>retention</th>
<th>compaction</th>
</tr>
</thead>
<tbody>
<tr>
<td>Raw (price)</td>
<td>3</td>
<td>3</td>
<td>7d</td>
<td>none</td>
</tr>
<tr>
<td>Indicator</td>
<td>1</td>
<td>2</td>
<td>30d</td>
<td>delete</td>
</tr>
<tr>
<td>Trade Exec</td>
<td>1</td>
<td>3</td>
<td>90d</td>
<td>none</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="3a-endtoend-interaction-scenarios">3‑A. End‑to‑End Interaction Scenarios (확장)</h3>
<p><em>(이전 표 + <code>RedoDiff</code> &amp; 카나리아 포함)</em></p>
<table>
<thead>
<tr>
<th>#</th>
<th>시나리오</th>
<th>요약</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td><strong>Sentinel Traffic Shift</strong></td>
<td>Ops → <code>/callbacks/sentinel-traffic</code> (weight=10→50). DAG Manager 업데이트 &amp; Gateway 라우팅 테이블 변경.</td>
</tr>
<tr>
<td>5</td>
<td><strong>RedoDiff for Hotfix</strong></td>
<td>버그 수정 코드 빠르게 패치 → <code>RedoDiff</code> gRPC 요청 → 새 토픽 vX.Y.Z‑hotfix 생성 후 스왑</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="3b-control-events-queueupdated-new">3‑B. Control Events (QueueUpdated) (New)</h3>
<p>DAG Manager publishes control‑plane updates about queue availability and tag resolution so that Gateways can update SDKs in real time without polling.</p>
<ul>
<li>Publisher: DAG Manager → ControlBus (internal)</li>
<li>Event: <code>QueueUpdated</code> with schema</li>
</ul>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;QueueUpdated&quot;,
  &quot;tags&quot;: [&quot;BTC&quot;, &quot;price&quot;],
  &quot;interval&quot;: 60,
  &quot;queues&quot;: [&quot;q1&quot;, &quot;q2&quot;],
  &quot;etag&quot;: &quot;q:BTC.price:60:77&quot;,
  &quot;ts&quot;: &quot;2025-08-28T09:00:00Z&quot;
}
</code></pre>
<p>Semantics
- Partition key: <code>hash(tags, interval)</code>; ordering within partition only
- At‑least‑once delivery; consumers must deduplicate by <code>etag</code>
- Gateways subscribe and rebroadcast via WS to SDK; SDK TagQueryManager heals via periodic HTTP reconcile on divergence</p>
<pre><code class="language-mermaid">sequenceDiagram
    participant G as Gateway
    participant D as DAG Manager
    Note over G,D: Canary traffic 10% → 50%
    G-&gt;&gt;D: /callbacks/sentinel-traffic weight=0.5
    D--&gt;&gt;G: 202 OK
</code></pre>
<hr />
<p>Note: In the current architecture, control updates (e.g., queue/tag changes, traffic weights) are also published to the internal ControlBus and consumed by Gateways for WebSocket relay to SDKs. The callback interface above remains for backward compatibility and operational tooling.</p>
<h2 id="4-garbage-collection-orphan-queue-gc">4. Garbage Collection (Orphan Queue GC) (확장)</h2>
<ul>
<li><strong>Policy Matrix:</strong></li>
</ul>
<table>
<thead>
<tr>
<th>Queue Tag</th>
<th>TTL</th>
<th>Grace Period</th>
<th>GC Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>raw</code></td>
<td>7d</td>
<td>1d</td>
<td>drop</td>
</tr>
<tr>
<td><code>indicator</code></td>
<td>30d</td>
<td>3d</td>
<td>drop</td>
</tr>
<tr>
<td><code>sentinel</code></td>
<td>180d</td>
<td>30d</td>
<td>archive S3</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>Archive Implementation:</strong> sentinel queues are uploaded to S3 using
  <code>S3ArchiveClient</code> before deletion.</p>
</li>
<li>
<p><strong>Dynamic Rate Limiter:</strong> Prometheus <code>kafka_server_BrokerTopicMetrics_MessagesInPerSec</code> &gt; 80% → GC batch size halve.</p>
</li>
</ul>
<hr />
<h2 id="5">5. 장애 시나리오 &amp; 복구 (확장)</h2>
<table>
<thead>
<tr>
<th>장애</th>
<th>영향</th>
<th>탐지 메트릭</th>
<th>복구 절차</th>
<th>알림</th>
</tr>
</thead>
<tbody>
<tr>
<td>Neo4j leader down</td>
<td>Diff 거절</td>
<td><code>raft_leader_is_null</code></td>
<td>Automat. leader election</td>
<td>PagerDuty</td>
</tr>
<tr>
<td>Kafka ZK session loss</td>
<td>토픽 생성 실패</td>
<td><code>kafka_zookeeper_disconnects</code></td>
<td>Retry exponential, fallback admin node</td>
<td>Slack #ops</td>
</tr>
<tr>
<td>Diff Stream stall</td>
<td>Gateway timeout</td>
<td><code>ack_status=timeout</code></td>
<td>Resume from last ACK offset</td>
<td>Opsgenie</td>
</tr>
</tbody>
</table>
<hr />
<p>각 행은 Runbook 마크다운 파일과 대응되는 ID를 가지며, Grafana Dashboard URL과
교차 링크된다. 이를 통해 "재현 가능 사고 대응" 절차를 문서화한다.</p>
<h2 id="6">6. 관측 &amp; 메트릭 (확장)</h2>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Alert Rule</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>diff_duration_ms_p95</code></td>
<td>&lt;80 ms</td>
<td><code>&gt;200ms for 5m → WARN</code></td>
</tr>
<tr>
<td><code>queue_create_error_total</code></td>
<td>=0</td>
<td><code>&gt;0 in 15m → CRIT</code></td>
</tr>
<tr>
<td><code>sentinel_gap_count</code></td>
<td>&lt;1</td>
<td><code>&gt;=1 → WARN</code></td>
</tr>
<tr>
<td><code>nodecache_resident_bytes</code></td>
<td>stable</td>
<td><code>&gt;5e9 for 5m → WARN</code></td>
</tr>
<tr>
<td><code>orphan_queue_total</code></td>
<td>↓</td>
<td>trend up 3h → GC inspect</td>
</tr>
<tr>
<td><code>compute_nodes_total</code></td>
<td>&lt;50k</td>
<td><code>&gt;50k for 10m → WARN</code></td>
</tr>
<tr>
<td><code>queues_total</code></td>
<td>&lt;100k</td>
<td><code>&gt;100k for 10m → WARN</code></td>
</tr>
</tbody>
</table>
<p>Clusters should scale before approaching these limits: expand Neo4j memory or
add Kafka brokers to sustain ingest throughput.</p>
<hr />
<h2 id="7">7. 보안 (확장)</h2>
<ul>
<li><strong>Authn:</strong> mTLS + JWT assertion. Key rotation 12h.</li>
<li><strong>Authz:</strong> Neo4j RBAC + Kafka ACL (<code>READ_TOPIC</code>, <code>WRITE_TOPIC</code>).</li>
<li><strong>Audit:</strong> 모든 Diff req/res → OpenTelemetry trace + hash.</li>
</ul>
<hr />
<h2 id="8">8. 잠재 취약점 &amp; 완화 (확장)</h2>
<table>
<thead>
<tr>
<th>취약점</th>
<th>레벨</th>
<th>설명</th>
<th>완화</th>
</tr>
</thead>
<tbody>
<tr>
<td>Graph Bloat</td>
<td>Medium</td>
<td>수천 version 누적</td>
<td>Sentinel TTL·archive, offline compaction</td>
</tr>
<tr>
<td>Hash Collision</td>
<td>Low</td>
<td>SHA256 collision improb.</td>
<td>SHA‑3 512 fallback + audit log</td>
</tr>
<tr>
<td>Queue Name collision</td>
<td>Low</td>
<td>broker lower-case uniqueness</td>
<td>Append <code>_v{n}</code> suffix</td>
</tr>
<tr>
<td>Stats Flood</td>
<td>Medium</td>
<td>GetQueueStats abuse</td>
<td>rate‑limit (5/s), authz scope</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-service-level-objectives-slo">9. Service Level Objectives (SLO)</h2>
<table>
<thead>
<tr>
<th>SLO ID</th>
<th>Target</th>
<th>Measurement</th>
<th>Window</th>
</tr>
</thead>
<tbody>
<tr>
<td>SLO‑1</td>
<td>Diff p95 &lt;100 ms</td>
<td>Prom histogram</td>
<td>28d</td>
</tr>
<tr>
<td>SLO‑2</td>
<td>Queue create success 99.9%</td>
<td>success/total</td>
<td>30d</td>
</tr>
<tr>
<td>SLO‑3</td>
<td>Sentinel gap =0</td>
<td>gauge</td>
<td>90d</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="10-testing-validation">10. Testing &amp; Validation</h2>
<ul>
<li><strong>Unit:</strong> <code>pytest plugins</code> → hash calculation, schema diff edge cases.</li>
<li><strong>Integration:</strong> Docker‑Compose (Kafka, Neo4j, Gateway stub) → Diff latency, GC batch.</li>
<li><strong>Chaos:</strong> Toxiproxy split‑brain, network delay injection.</li>
<li><strong>CI/CD Gate:</strong> SSA DAG Lint와 20종 백테스트 → 24h 카나리아 → 50% 프로모션
  이후 자동 배포, <code>dagmanager redo-diff --sentinel &lt;id&gt; --rollback</code>으로 역방향 롤백.</li>
</ul>
<hr />
<h2 id="11-admin-cli-snippets">11. Admin CLI Snippets (예)</h2>
<pre><code class="language-shell"># diff dry_run
qmtl dagmanager diff --file dag.json --dry_run
# queue stats
qmtl dagmanager queue-stats --tag indicator --interval 1h
# trigger GC for a sentinel
qmtl dagmanager gc --sentinel v1.2.3
# export schema DDL
qmtl dagmanager export-schema --out schema.cypher
</code></pre>
<p>For canary deployment steps see
<a href="../../operations/canary_rollout/"><code>docs/canary_rollout.md</code></a>.</p>
<h2 id="12_1">12. 서버 설정 파일 사용법</h2>
<p><code>qmtl dagmanager-server</code> 서브커맨드는 YAML 형식의 설정 파일 하나만 받는다.
아래 예시와 같이 모든 서버 옵션을 YAML에 작성하고 필요하다면 <code>--config</code> 옵션으로 경로를 지정한다.</p>
<p>예시:</p>
<pre><code class="language-yaml">neo4j_dsn: bolt://db:7687
neo4j_user: neo4j
neo4j_password: secret
kafka_dsn: localhost:9092
</code></pre>
<p>The sample file installed by <code>qmtl init</code> instead defaults to in-memory
repositories and queues for local development. Uncommenting the DSN lines above
enables Neo4j and Kafka integrations respectively.</p>
<pre><code># 기본값으로 실행
qmtl dagmanager-server

# YAML 설정 파일로 실행
qmtl dagmanager-server --config qmtl/examples/qmtl.yml
</code></pre>
<p>해당 명령은 <code>qmtl/examples/qmtl.yml</code> 의 <code>dagmanager</code> 섹션을 읽어 서버를 실행한다.
<code>--config</code> 옵션을 생략하면 DSN이 제공되지 않으므로 메모리 레포지토리와 큐가
사용된다. 샘플 파일에는 모든 필드를 주석과 함께 설명한다.</p>
<p>Available flags:</p>
<ul>
<li><code>--config</code> – optional path to configuration file.</li>
</ul>
<p><strong>Related:</strong> <a href="../">Overview</a>, <a href="../architecture/">Architecture &amp; Ownership</a>, <a href="../glossary/">Glossary</a>, <a href="./">DAG Manager</a>, <a href="../gateway/">Gateway</a>, <a href="../worldservice/">World Service</a>, <a href="../controlbus/">ControlBus</a>, <a href="../lean_brokerage_model/">Lean Brokerage Model</a>, <a href="../../reference/api/brokerage/">Brokerage API</a>, <a href="../implementation_todos/">Implementation TODOs</a></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top", "navigation.expand", "navigation.path"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>