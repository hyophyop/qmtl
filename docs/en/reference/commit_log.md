# Commit Log Configuration

Gateway can optionally publish and consume commit-log records via Kafka. The
settings below live under the `gateway` section of the YAML configuration
file.

- When running with ``profile: prod`` the Gateway process **exits during
  startup** if ``commitlog_bootstrap`` or ``commitlog_topic`` are missing to
  avoid silent loss of ingestion durability.
- For local development (``profile: dev``), leaving these fields blank simply
  disables commit-log publishing and emits an informational log.

```yaml
gateway:
  commitlog_bootstrap: "localhost:9092"
  commitlog_topic: "commit-log"
  commitlog_group: "gateway-commits"
  commitlog_transactional_id: "gateway-writer"
```

- `commitlog_bootstrap` – Kafka bootstrap servers for commit-log topics.
- `commitlog_topic` – Compacted topic storing commit-log records.
- `commitlog_group` – Consumer group id used by Gateway when processing the
  commit log.
- `commitlog_transactional_id` – Transactional id for the commit-log writer's
  idempotent producer.

When configured, Gateway will start a `CommitLogConsumer` in its event loop and
route deduplicated records to its processing callback. On shutdown the consumer
is stopped and the writer's producer is closed. Production deployments **must**
configure both ``commitlog_bootstrap`` and ``commitlog_topic`` so the Gateway
can durably record submission events; the CLI prints a warning when the writer
is disabled.

## `gateway.ingest` Submission Records

Every accepted strategy submission is written to the commit log before the
request is queued. The record value is encoded as the tuple
``["gateway.ingest", <timestamp_ms>, <strategy_id>, <payload>]`` so it remains
compatible with :class:`~qmtl.services.gateway.commit_log_consumer.CommitLogConsumer`.
The message key is ``ingest:<strategy_id>`` to preserve append-only semantics.

The payload object contains all data required to replay an ingestion event:

| Field | Description |
| --- | --- |
| ``event`` | Constant ``"gateway.ingest"`` marker. |
| ``version`` | Payload schema version (currently ``1``). |
| ``strategy_id`` | UUID assigned to the submission. |
| ``dag_hash`` | Canonical SHA256 hash of the submitted DAG prior to sentinel injection. |
| ``dag`` | Stored DAG JSON (including any injected ``VersionSentinel`` node). |
| ``dag_base64`` | Base64 representation of ``dag`` for quick transport. |
| ``node_ids_crc32`` | CRC32 checksum supplied by the client. |
| ``insert_sentinel`` | Boolean flag indicating whether Gateway appended a sentinel node. |
| ``compute_context`` | Normalised compute context with ``world_id``, ``execution_domain``, ``as_of``, ``partition`` and ``dataset_fingerprint`` when supplied. When Gateway downgrades into safe mode the payload also includes ``downgraded``, ``downgrade_reason`` (a value from the shared ``DowngradeReason`` enum) and ``safe_mode``. |
| ``world_ids`` | Ordered list of unique world identifiers associated with the submission. |
| ``world_id`` | Primary world identifier when provided. |
| ``meta`` | Original submission metadata (JSON coerced). |
| ``submitted_at`` | ISO‑8601 timestamp generated by Gateway. |

Downstream consumers can rely on this record to rebuild the submission state or
audit client metadata before requeueing.

## `gateway.rebalance` Order Batches

Rebalancing submissions reuse the commit log via the tuple
``["gateway.rebalance", <timestamp_ms>, <batch_id>, <payload>]``. Each payload
contains the batch scope (`per_world`, `global`, or `per_strategy`), the
associated world identifier, the generated orders, and derived metrics such as
the reduce-only ratio. When shared-account netting is active the payload sets
``shared_account`` to `true` so downstream services can distinguish shared
orders from per-world execution flows.
