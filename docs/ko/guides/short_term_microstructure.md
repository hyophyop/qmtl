# 단기 마이크로스트럭처 필터

짧은 구간의 오더북 전략은 **마이크로프라이스**, **호가 불균형**,
**대기열 우선순위**를 함께 활용할 때 가장 안정적입니다. 이 문서는 새로
추가된 런타임 노드를 소개하고, 진입 결정을 조건부로 제어하는 방법을
설명합니다.

## 마이크로프라이스 + 불균형 노드

`microprice_imbalance()`는 오더북 스냅샷을 해석하여 가중 마이크로프라이스와
상위 `N` 레벨의 부호 있는 불균형 값을 동시에 제공합니다.

- `top_levels`는 불균형 비율에 포함할 레벨 수를 조절합니다.
- `epsilon`은 양쪽 호가가 모두 비어 있을 때 분모를 안정화합니다.
- 반환된 노드는 `"microprice"`, `"imbalance"` 키를 가진 매핑을 내보내므로
  후속 노드에서 바로 재사용할 수 있습니다.

## 우선순위 지수

`priority_index()`는 대기열 메타데이터를 `[0, 1]` 구간의 점수로 정규화하며,
`1`은 주문이 호가 맨 앞에 있음을 의미합니다. 입력 스냅샷에는 반드시
`queue_rank`, `queue_size` 값(스칼라 또는 동일 길이의 시퀀스)이 포함되어야
합니다. 잘못된 값이나 누락된 값은 `None`으로 변환되어 후속 로직에서 안전하게
제거할 수 있습니다.

## 조건부 진입 필터

`conditional_entry_filter()`는 마이크로프라이스 지표와 우선순위 지수를 묶어서
불리언 게이트를 생성합니다. 노드는 다음 조건을 모두 검사합니다.

1. 마이크로프라이스가 존재하고(필요 시 범위 내인지) 있는지,
2. 불균형 값이 지정한 `(최소, 최대)` 창 안에 있는지,
3. 우선순위 지수가 설정한 한계를 만족하는지.

우선순위 노드가 시퀀스를 반환하면 `priority_mode="any"`로 최소 하나만 통과
시키거나, `"all"`로 모든 항목이 조건을 충족하도록 선택할 수 있습니다.
기본 설정은 완만한 불균형(±0.25)만 허용하고 대기열 상위 절반(`0.6–1.0`)에 있는
주문을 선호합니다.

## 예제 파이프라인

`examples/microprice_priority_strategy.py` 모듈은 위 노드들을 조합하여 최소한의
전략 게이트를 구성합니다.

```python
from examples.microprice_priority_strategy import build_pipeline

artifacts = build_pipeline()
entry_gate = artifacts.entry_gate
# CacheView로 오더북 스냅샷과 대기열 메타데이터를 공급하세요.
```

모듈을 스크립트로 실행하면 (`python examples/microprice_priority_strategy.py`) 시뮬레이션된
마이크로프라이스, 불균형, 우선순위 지수, 그리고 최종 `allow_entry` 플래그가 출력됩니다.
전체 DAG에 지표를 통합할 때 이 스캐폴드를 재사용할 수 있습니다.
