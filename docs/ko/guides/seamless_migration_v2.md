# Seamless Data Provider v2 마이그레이션

> **상태:** 마이그레이션 가이드는 이제 실행 가능합니다. 분산 백필 코디네이터, SLA 엔진, 관련 메트릭이 기본 런타임에 포함되어 있습니다. 이 체크리스트를 따라 전략을 v2 스택으로 이전하고 v1 폴백을 정리하세요.

Seamless Data Provider v2 롤아웃은 필수 SLA 집행, 분산 백필 조정, 향상된 가시성을 도입합니다. 스키마 레지스트리 거버넌스는 여전히 선택 사항이지만 최종 v2 마일스톤으로 채택을 권장합니다.

## 사전 준비

- `seamless-backfill-coordinator` 서비스가 배포되어 접근 가능한지 확인하고, 런타임 구성에 `seamless.coordinator_url` 을 설정합니다.
- `operations/monitoring/seamless_v2.jsonnet` 에 있는 관측 번들을 배포해 `backfill_completion_ratio`, `seamless_sla_deadline_seconds` 를 Grafana에서 확인하세요.
- SLA 목표를 구성에 반영합니다. 정책은 이제 런타임에서 집행됩니다.

## 마이그레이션 단계

### 1. 적합성 파이프라인 프로토타입

1. 통합 테스트에서 `ConformancePipeline` 을 명시적으로 인스턴스화해 정규화 리포트를 수집합니다. 기본 값이 차단 모드로 전환되기 전까지 런타임 wiring은 옵트인입니다.
2. `seamless_conformance_flag_total` 을 로컬(또는 스테이징)에서 수집해 드리프트를 측정합니다. 프로덕션 스크래핑은 아직 준비되지 않았습니다.
3. 대시보드와 알람 쿼리를 업데이트해 `seamless_conformance_flag_total`/`_warning_total` 이 내보내는 새로운 `interval`, `world_id` 라벨을 포함합니다.
4. 레지스트리 지원이 도착하면 신속히 차단 모드로 전환할 수 있도록 스키마 가정을 문서화합니다.

### 2. 분산 백필 코디네이터 도입

1. 기본 코디네이터를 사용하도록 전략을 구성합니다. `seamless.coordinator_url` 이 설정되면 SDK는 자동으로 `DistributedBackfillCoordinator` 를 초기화합니다.
2. 스테이징에서 `backfill_completion_ratio` 를 검증해 리스가 수렴하고 샤드가 중복되지 않는지 확인하세요.
3. 온콜을 위해 `scripts/lease_recover.py` 를 사용한 복구 절차를 문서화하고, 프로덕션 트래픽을 넘기기 전에 스테이징에서 리허설하세요.

### 3. SLAPolicy 예산 집행

1. 각 Seamless 소비자에 대해 구체적인 데드라인을 `SLAPolicy` 인스턴스에 연결합니다.
2. 스테이징에서 제한 초과가 `SeamlessSLAExceeded` 를 발생시키고 `seamless-sla-*` 규칙으로 알람이 발동하는지 확인합니다. `scripts/inject_sla_violation.py` 스크립트를 사용해 새로운 임계값 적용 전에 파이프라인을 검증할 수 있습니다.
3. SLA 대시보드에 설명된 새로운 문제 해결 흐름을 런북에 업데이트합니다.

### 4. 스키마 검증 롤아웃 계획

1. `ConformancePipeline` 리포트로 현재 정규화에 실패하는 컬럼을 식별합니다.
2. 레지스트리 지원이 연결되면 가장 먼저 엄격 모드를 적용할 데이터셋을 결정합니다.
3. 알람 정의를 준비하되, 메트릭이 방출될 때까지 비활성 상태로 유지합니다.

### 5. 테스트 커버리지 확장

- CI에서 기존 Seamless 검증 스위트를 유지해 회귀를 조기에 포착하세요.
- Hypothesis 기반 속성 테스트를 추가해 분산 코디네이터 엣지 케이스를 다룹니다.
- `seamless_fault_injection` 픽스처를 활용해 SLA 데드라인에 대한 재시도 동작을 검증하세요.

## 롤백 플랜

신규 구성요소 롤아웃 후 문제가 발생하면:

1. `seamless.conformance.mode=shadow` 로 전환해 가시성은 유지하되 읽기 차단을 중단합니다.
2. 집행 레이어가 안정될 때까지 SLA 구성 오버라이드를 되돌립니다.
3. 새 코디네이터가 복구되는 동안 스토리지 소스를 우선시해 캐시 데이터를 사용합니다.

항상 Seamless 포스트모템 트래커에 사건과 복구 조치를 기록해 교훈이 런북으로 환류되도록 하세요.

## 완료 정의

다음 조건을 만족하면 마이그레이션을 완료로 간주합니다.

- 적합성 파이프라인이 차단 모드로 실행되며 열린 회귀가 없습니다.
- 백필 코디네이터 리스와 SLA 대시보드가 정상 기준선을 유지합니다.
- 스키마 검증이 엄격 모드이며 문서화되었습니다(레지스트리 작업이 미완료일 경우 승인된 예외가 기록되어야 함).
- 테스트가 회귀, 장애 주입, 관측 가드를 커버합니다.
- 전략 런북이 레거시 v1 대신 분산 코디네이터와 SLA 대시보드를 참조합니다.
