# YAML 전용 구성 오버홀

## 개요
이 문서는 모든 QMTL 구성 요소를 단일 YAML 기반 구성 소스로 이전하기 위한 구현 로드맵을 정리합니다. [이슈 #1337](https://github.com/hyophyop/qmtl/issues/1337)에 추적된 작업 범위를 다루며, 이후 워크스트림이 따라야 할 가드레일을 정의합니다.

## 목표
- 서비스, SDK 도구, Seamless 런타임, 예제를 포함한 모든 영역에서 환경 변수 기반 설정을 제거합니다.
- 모든 컴포넌트가 공유하는 정규화된 스키마와 검증 흐름을 제공합니다.
- 로컬 개발·CI·프로덕션 전체 스택이 YAML 정의만으로 부팅되도록 만듭니다.

## 비목표
- 통합 작업과 무관한 새로운 구성 키 도입
- 구성 부트스트래핑과 무관한 런타임 플래그 리팩터링
- 외부에 구성 위임이 이뤄지는 벤더 SDK 수정

## 워크스트림
에픽은 아홉 개의 집중 워크스트림으로 분해되었습니다. 각 스트림은 여기서 정의한 규칙을 준수하고 담당 영역에 대한 단위/통합 커버리지를 제공해야 합니다.

| Workstream | 설명 | 핵심 산출물 | 승인 신호 |
| --- | --- | --- | --- |
| #1338 통합 YAML 스키마 | `qmtl/config/schema.yaml` 로 모든 설정 스탠자를 정의하고 데이터클래스 바인딩/문서를 작성 | 스키마 파일, 로더 모델, 스키마 문서 | 스키마가 예제 로더와 왕복, 문서 갱신 |
| #1339 구성 로더 & CLI | 흩어진 로더를 통합 `qmtl.config` 패키지로 교체하고 `qmtl config validate` 확장 | 로더 모듈, CLI 재작성, 테스트 | CLI가 잘못된 문서를 즉시 실패, 단일 import 경로 |
| #1340 WorldService 마이그레이션 | WorldService 부트를 로더로 이전하고 env 읽기를 제거 | 서비스 배선 변경, 시스템 테스트 | 서비스가 YAML만으로 부팅 |
| #1341 Gateway & DAG Manager | 위와 동일, Gateway/DAG Manager 대상 | 서비스 구성 어댑터, HTTP/WS 테스트 | 두 서비스 모두 로더에 의존 |
| #1342 Seamless 런타임 | Seamless 런타임 설정을 YAML로 이전(스냅샷, 캐시 노브 포함) | YAML 인입 레이어, 런타임 테스트 | Seamless 런타임이 env 기본값 없이 시작 |
| #1343 SDK/커넥터/캐시 | SDK CLI, 커넥터, 캐시가 YAML을 읽도록 업데이트 | CLI 업데이트, 커넥터 어댑터, 캐시 | CLI 도움말이 YAML을 안내, env 읽기 제거 |
| #1344 문서 개편 | 문서/가이드/템플릿이 YAML 구성을 참조하도록 업데이트 | 문서, 내비, 예제 | 환경 변수를 언급하는 문서 제거 |
| #1345 운영 템플릿 | `docs/templates/` 및 운영 플레이북을 새 워크플로로 갱신 | 템플릿, 검증 단계 | 운영 런북이 YAML 주입을 설명 |
| #1346 테스트/검증 | YAML 준수를 위한 자동 검증을 확대 | 테스트 하니스, CI 배선 | 프리플라이트가 YAML 전용 부팅을 보장 |

## 횡단 요구 사항
- **구성 패키지:** 모든 새 로더는 `qmtl/config/` 네임스페이스에 위치하고 스키마·검증·IO 헬퍼를 명확히 분리합니다.
- **환경 변수 종료:** 각 `os.getenv` 사용처를 파악해 삭제하거나 YAML 로더를 읽는 호환성 시므로 교체합니다. 시므는 경고를 출력하고 추후 제거를 추적해야 합니다.
- **시크릿 관리:** YAML 형식은 SOPS, Vault 등의 시크릿 백엔드 참조를 지원해야 합니다. 참조 문법 표준화를 문서화하되 백엔드 통합은 후속 이슈로 미룰 수 있습니다.
- **하위 호환성:** CLI 출력과 로그에서 감가상각 경고를 노출해 전환 기간을 제공합니다. 각 워크스트림은 사용자가 env 기반 구성에서 이동하는 방법을 명시해야 합니다.
- **검증 레벨:** 롤아웃 동안 점진 도입을 위해 `strict`, `permissive` 검증 모드를 정의합니다. 마이그레이션 완료 시 strict 모드를 기본으로 전환합니다.

## 마이그레이션 플랜
1. **스키마 기반 구축 (1~2주)**
   - 구성 분류를 확정하고 표준 스키마 파일 작성.
   - `examples/config/` 에 로컬/스테이징/프로덕션 샘플 추가.
2. **로더 & CLI (2~3주)**
   - 로더 패키지 도입, CLI 검증 명령 마이그레이션.
   - 스키마 기반 도움말 출력 구현.
3. **서비스 롤아웃 (3~5주)**
   - WorldService, Gateway, DAG Manager, Seamless 런타임을 순차 마이그레이션.
   - 전환 기간 동안 YAML 옵트인 플래그 제공.
4. **SDK & 커넥터 (4~6주)**
   - SDK, 커넥터, 캐시가 로더 출력 소비.
   - 커뮤니티 커넥터용 어댑터 유틸리티 제공.
5. **문서 & 템플릿 (5~6주)**
   - 가이드, 운영 문서, 템플릿을 YAML 워크플로로 재작성.
   - env 변수 안내 문서는 감가상각 노트와 함께 보관.
6. **검증 & 정리 (6~7주)**
   - 단위/통합 테스트 확대.
   - 폐기된 env 경로 제거, strict 검증 확정.

## 테스트 전략
- YAML 예제와 로더 출력이 호환되는지 확인하는 스키마 스냅샷 테스트 추가.
- 모든 서비스가 `--config` 플래그를 노출하고 파일이 없으면 실패하도록 보장.
- `tests/config/` 에서 YAML 로더를 사용해 최소 인스턴스를 부팅하는 통합 테스트 추가.
- 환경 변수를 제거한 상태에서 기존 `uv run -m pytest -W error -n auto` 스위트를 실행해 회귀를 탐지.

## 운영 고려 사항
- **배포 도구:** Helm, Terraform, Compose 등 배포 스크립트가 env 주입 대신 YAML ConfigMap/시크릿을 마운트하도록 업데이트합니다.
- **시크릿 로테이션:** YAML에 저장된 암호 값을 로테이션하는 방법을 문서화합니다.
- **관측성:** 시작 시 사용 중인 YAML 파일과 검증 모드를 구조화 로그로 출력합니다.

## 다음 단계
- 스키마 소유권을 공유하며 #1338, #1339를 병렬 시작.
- 감가상각 일정에 대한 사용자 커뮤니케이션 플랜 작성.
- 구성 변경(diff)을 ControlBus 이벤트로 노출할지 검토.

## 참고
- [이슈 #1337](https://github.com/hyophyop/qmtl/issues/1337) – 에픽 추적.
- [운영 Config CLI](../operations/config-cli.md) – 업데이트 예정인 기존 CLI 사용 방법.
