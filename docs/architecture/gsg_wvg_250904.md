# GSG/WVG 설계 보강안 (임시 RFC)

좋은 포인트예요. \*\*“글로벌 DAG은 단일(중복 없음), 유효성 평가는 월드별로 독립”\*\*이라는 목표를 문서에서 *명확하고 실행 가능한 규칙*으로 못 박아두면, 이후 운영·개발·거버넌스에서 큰 이득이 있습니다. 아래는 \*\*문서 보강 제안(섹션 구조 + 삽입 가능한 스펙 문구)\*\*입니다. 필요 시 그대로 문서에 붙여 넣을 수 있도록 **RFC 스타일의 MUST/SHOULD/MAY** 규칙과 **샘플 스키마**까지 포함했습니다.

---

## Normative Addendum — 권장 문구(프로젝트 전역 합의용)

- 책임 경계(SSOT): GSG는 DAG Manager(Neo4j)의 불변 SSOT이고, WVG(WorldNodeRef/Validation/DecisionEvent)는 WorldService(월드 DB)의 가변 SSOT다. DAG Manager는 WVG를 저장·갱신하지 않으며, WorldService는 GSG를 변경하지 않는다.
- NodeID 규칙: NodeID는 Canonical(NodeType, interval, period, params(canonical & split), dependencies(sorted), schema_id, code_hash)의 바이트 직렬화에 대한 프로젝트 표준 해시이다.
- 해시 알고리즘 정렬: 기본 해시는 BLAKE3를 사용한다. 문서·코드 전역에서 BLAKE3로 통일하며, 변경은 ADR로 관리한다.
- 결정 용어 분리: 운영 중단류(stop/pause/resume/quarantine)는 DecisionEvent(scope 기본 world-local)로 취급하고, WS의 정책 판단 결과는 DecisionEnvelope로 구분한다. 둘은 저장 위치와 소비 주체가 다르다.

---

## 0) TL;DR (문서에 바로 들어갈 요약)

* **Global Strategy Graph (GSG)**: 전략과 모든 구성 노드를 \*\*내용 주소화(content-addressed)\*\*로 단일화한 전역 DAG. \*\*중복 노드 없음(uniqueness)\*\*이 불변식.
* **World View Graph (WVG)**: 각 월드(World)가 GSG를 참조해 만든 **오버레이 뷰**. 월드별 **유효성(Validation)**, **정책(Policy)**, **리소스**, \*\*데이터 지문(Fingerprint)\*\*은 WVG에만 기록.
* **중단(Abort/Stop) 격리**: 중단·무효 판정의 **기본 범위(scope)는 월드-로컬**. 전파는 **명시적 opt-in**일 때만.
* **평가 캐시 키(EvalKey)** = `hash(NodeID || WorldID || ContractID || DatasetFingerprint || CodeVersion || ResourcePolicy)`.
  동일 노드라도 월드가 다르면 **평가 레코드가 다르다**.


---

## 1) 핵심 용어 정의(Definition)

**Strategy**

* 전략은 GSG에서 하나의 **루트 노드**(StrategyRoot)로 표현된다.
* 전략 ID는 `StrategyID = NodeID(StrategyRoot)`.

**Node**

* 노드는 연산자(예: 인디케이터, 규칙), 매개변수, 하위 의존성의 \*\*내용 표준화 표현(canonical form)\*\*을 해시해 만든 **내용 주소화 식별자**를 갖는다.
* `NodeID = Hash(Canonical(NodeType, interval, period, Params, Dependencies(sorted), schema_id, code_hash))`. // 기본 해시: BLAKE3

**Global Strategy Graph (GSG)**

* 모든 노드는 **유일한 NodeID**로 식별되며 **중복 저장 금지**가 **MUST**.
* 에지는 함수적 의존성(데이터 흐름/구성)을 나타낸다.
* GSG는 **월드 불문**의 전역 저장소.

**World**

* 거래소/자산군/시장시간/체결규칙/리스크 정책/비용모형/데이터 소스 버전 등을 포함하는 **실행·평가 컨텍스트**.
* `WorldID`는 **월드 설정의 버전된 스냅샷**에 대한 식별자여야 한다(가변 구성 방지).

**World View Graph (WVG)**

* 특정 월드가 GSG를 \*\*참조(reference)\*\*하여 구성한 **월드-로컬 오버레이 그래프**.
* 각 노드에 대해 월드-로컬 메타(유효성, 상태, 리소스, 예산, 스케줄링 등)를 부착.
* SSOT: WVG(WorldNodeRef/Validation/DecisionEvent)는 WorldService가 소유·저장(가변)하고, GSG는 DAG Manager가 소유(불변·append-only)한다.

**Validation**

* 특정 `(WorldID, NodeID)`에 대해 수행되는 **월드-로컬 검증**.
* 결과는 GSG가 아니라 **WVG**에만 저장해야 한다(MUST).

**Submission**

* 하나의 전략(StrategyID)을 하나 이상의 월드에 바인딩하는 행위. 결과물은 월드별 **WorldStrategyBinding(WSB)**.

---

## 2) 불변식(Invariants)

1. **전역 유일성**: 동일 내용을 가진 노드는 **GSG 내 하나의 NodeID만** 존재해야 한다(MUST).
2. **평가 격리**: **유효성·중단 결정은 기본적으로 월드-로컬**이어야 한다(MUST).
3. **무해 전파의 기본값**: 한 월드에서 전략/노드가 **중단되어도 다른 월드에 영향 없음**(MUST).
4. **명시적 전파만 허용**: 전파하려면 \*\*결정 이벤트에 `decision.scope != "world-local"`\*\*을 명시해야 한다(MUST). 기본값은 `"world-local"`(MUST).
5. **재현성**: Validation은 \*\*입력 컨텍스트(데이터/정책/코드)\*\*를 포함한 키로 캐시되어야 한다(SHOULD).
6. **가시성 분리**: 대시보드·알람은 **월드별 뷰**가 기본이며, 전역 집계는 파생 지표로 제공(SHOULD).

---

## 3) 데이터 모델(간단 JSON 스키마 예시)

```json
// GSG: 전역 노드 저장
{
  "Node": {
    "node_id": "blake3:...",        // REQUIRED, content-addressed (해시 표기는 예시)
    "node_type": "Operator|Source|Rule|Root",
    "schema_version": "v1",
    "params": { "...": "..." },     // 모든 분리 가능한 파라미터는 개별 필드 (사용자 선호 반영)
    "dependencies": ["node_id", "..."],
    "code_version": "git:abcd1234"  // 구현 바이트코드를 간접 참조
  }
}
```

```json
// World: 버전 고정된 컨텍스트
{
  "World": {
    "world_id": "world:krx-spot-v2025.09.01",
    "contract_id": "policy:krx-baseline-v5",
    "market_config": { "tz": "Asia/Seoul", "lot": 1, "fees": "...", "slippage_model": "..." },
    "dataset_fingerprint": "lake:blake3:...",
    "risk_limits": { "...": "..." }
  }
}
```

```json
// 월드 오버레이 (WVG) - 월드별 노드 뷰
{
  "WorldNodeRef": {
    "world_id": "world:...",
    "node_id": "blake3:...",
    "status": "unknown|validating|valid|invalid|stopped|running|paused|archived",
    "last_eval_key": "blake3:EvalKey",
    "annotations": { "budget": "...", "owner": "...", "notes": "..." }
  }
}
```

```json
// Validation 레코드 (월드-로컬)
{
  "Validation": {
    "eval_key": "blake3:hash(node_id||world_id||contract_id||dataset_fp||code_version||resource_policy)",
    "world_id": "world:...",
    "node_id": "blake3:...",
    "result": "valid|invalid|warning",
    "metrics": { "pnl": 0.0, "sharpe": 1.2, "coverage": 0.93, "...": "..." },
    "timestamp": "2025-09-04T02:33:00Z"
  }
}
```

```json
// 결정 이벤트 (중단/정지 등)
{
  "DecisionEvent": {
    "event_id": "uuid",
    "world_id": "world:...",        // REQUIRED for world-local
    "node_id": "blake3:...",        // 전략 루트면 전략 단위
    "decision": "stop|pause|resume|quarantine",
    "reason_code": "VAL_FAIL|RISK_TRIP|OP_INCIDENT|MANUAL",
    "scope": "world-local|multi-world|global",  // default: world-local
    "propagation_rule": "none|same-contract|same-dataset|explicit-list",
    "ttl": "P0D|P7D|P30D",          // 전파 유효 기간, world-local은 무시
    "timestamp": "..."
  }
}
```

---

## 4) 상태 기계(State Machines)

**월드-노드 상태 (WVG 기준)**
`unknown → validating → (valid | invalid)`

* `valid → (running | schedulable)`
* `running → (paused | stopped)`
* `invalid → (fixed 후 validating 재시도)`
* `stopped`는 **월드-로컬 종료**이며 GSG/GSG의 다른 월드 뷰에는 영향 없음.

**전략(루트) 상태**: 각 월드에서 위 상태 기계를 **독립적으로** 갖는다. 전역에선 “월드별 상태 집계만” 제공.

---

## 5) 제출(Submission)과 바인딩(WSB)

* `POST /submission`: `{ strategy_id, world_ids[] }`
* 서버는 각 `world_id`에 대해 **WSB**를 만들고, 해당 월드의 **WVG**에 루트 노드를 “참조”로 올린다.
* 즉시 `Validation(StrategyRoot)` 잡이 월드별로 큐잉된다. **잡의 결과는 WVG에만 기록**.

---

## 6) 유효성 평가 설계(월드-로컬 캐시 키)

**EvalKey**

```
EvalKey = H(
  NodeID
  || WorldID
  || ContractID          // 월드 정책/룰셋
  || DatasetFingerprint  // 시계열/심볼 유효 기간까지 포함 권장
  || CodeVersion
  || ResourcePolicy      // 예산·동시성·메모리 제한 등
)
```

* 동일 Node라도 위 요소 중 하나라도 다르면 **평가 재실행**.
* 같은 월드라도 **데이터 스냅샷**이 바뀌면 재평가.

---

## 7) 중단(Abort/Stop) 규칙과 전파(Propagation)

* 기본: **`scope="world-local"`** (MUST) → **다른 월드에는 반영 금지**.
* 전파가 필요하면:

  * `scope="multi-world"` 또는 `"global"`을 **명시**하고,
  * `propagation_rule`로 **전파 범위**를 구체화(예: `same-contract`, `explicit-list`)해야 한다(MUST).
* 전파된 결정에도 **TTL**을 둬 **영구 오염 방지**(SHOULD).
* 대시보드 표기는 **붉은 표식은 해당 월드 탭에만**, 전역 페이지는 “사건 수/영향 월드 수” 같은 **집계 수치**만.

---

## 8) 그래프 모델: 중복 제거와 도달성(Reachability)

* **중복 제거**: `NodeID`는 **표준화 직렬화** 후 해시. 비결정적 필드(타임스탬프, 난수 시드)는 **표준화에서 제외**(MUST).
* **월드별 도달성**: 월드 정책으로 인해 일부 서브노드가 **사용 불가**일 수 있다(예: 파생상품 금지). 이때 WVG는 \*\*해당 에지의 “월드-로컬 비활성화”\*\*를 기록하여, 도달성·검증 범위를 월드별로 좁힌다(SHOULD).

---

## 9) 권한/격리(간단)

* **쓰기 경계**: GSG는 \*\*불변(append-only)\*\*이 이상적(SHOULD). 수정은 새로운 NodeID 생성.
* **WVG는 가변**: 유효성/상태/결정 이벤트는 월드별 스토어에만 기록(MUST).

---

## 10) 운영 관측(Observability)

* **전역**: “노드 재사용도(Reuse%), 월드별 성공률, 전파 사건 수”
* **월드**: “전략별 상태, 최근 Validation 히스토리, 중단 사유 분포”

---



## 12) 샘플 문구(문서에 그대로 삽입 가능)

> **전역-로컬 분리 원칙**
> QMTL은 \*\*Global Strategy Graph(GSG)\*\*와 \*\*월드 컨텍스트(World)\*\*를 분리한다. GSG는 전략과 구성 노드를 **내용 주소화**로 단일화하며, 동일 내용의 노드는 전역에서 **하나의 NodeID**만 존재한다. 유효성/실행 상태/중단 결정 등 **월드 의존적 산출물은 전적으로 월드 스토어에만 저장**되며, 기본적으로 **다른 월드로 전파되지 않는다**.

> **중단 결정의 범위**
> 어떤 월드에서 전략 또는 노드에 중단이 발생해도 **다른 월드에서는 독립적으로 유효할 수 있으므로 중단되면 안 된다**. 따라서 모든 결정 이벤트는 \*\*기본 범위가 `world-local`\*\*이어야 하며, 전파가 필요하면 **scope를 명시하고 명시적 규칙으로만** 확장한다.

> **평가 캐시 키**
> Validation 결과는 `(NodeID, WorldID, ContractID, DatasetFingerprint, CodeVersion, ResourcePolicy)`의 해시를 키로 캐시한다. 기본 해시는 BLAKE3이며, 같은 전략이라도 **월드가 다르면 결과가 다를 수 있음**을 시스템이 자연스럽게 보증한다.

---

## 13) 예시 플로우(동일 전략, 2개 월드)

1. `strategy S` 제출 → `World A`, `World B`.
2. GSG에는 변경 없음(노드 중복 없으므로).
3. `Validation(S, World A)` → **invalid**(예: 수수료·슬리피지 하에서 성과 불충족).
4. 운영자, **World A만** `stop(S)` 실행(기본 `scope=world-local`).
5. `Validation(S, World B)` → **valid** → `running`.
6. 전역 대시보드: “S, World A: Stopped / World B: Running”으로 **병렬 표시**.

---

## 14) 실패 모드 & 방어선(극단 포함)

* **잘못된 전파로 전 세계 중단(Extreme)**: 기본을 `world-local`로 강제, 전파는 **명시 + 승인** 워크플로 필요.
* **NodeID 드리프트**: 비결정적 필드 제거·표준화 실패 시 중복 난립 → **Canonicalizer 테스트**와 **스냅샷 고정**.
* **데이터 지문 누락**: 데이터 업데이트로 재현 불가 → **DatasetFingerprint 필수화(MUST)**.
* **월드 설정 변이**: 환경이 바뀌었는데 같은 WorldID 사용 → **WorldID는 버전드 스냅샷** 강제.
* **의존 노드 일부만 invalid**: 월드별 **도달성 그래프**로 실제 실행 경로만 검증.

---

## 15) 테스트 체크리스트(문서 부록 추천)

* [ ] 동일 NodeID가 여러 레코드로 생성되지 않는가(GSG 중복 불가).
* [ ] World A에서 `stop` 후 World B 실행에 영향 없는가.
* [ ] EvalKey 구성 요소 하나라도 바꾸면 재평가 되는가.
* [ ] World 설정/데이터 버전이 바뀌면 상태가 `validating`으로 회귀하는가.
* [ ] 기본 대시보드가 월드별 격리를 올바르게 시각화하는가.

---

## 16) API 초안(간결 버전)

```http
POST /submit
{
  "strategy_id": "blake3:...",
  "world_ids": ["world:krx-spot-v2025.09.01","world:cme-fut-v2025.09.01"]
}
→ 202 Accepted
```

```http
GET /status?strategy_id=blake3:...&world_id=world:krx-spot-v2025.09.01
→ {
  "world_id": "...",
  "strategy_id": "...",
  "status": "stopped",
  "last_eval": { "result": "invalid", "eval_key": "..." }
}
```

```http
POST /decision
{
  "world_id": "world:krx-spot-v2025.09.01",
  "node_id": "blake3:... (strategy root)",
  "decision": "stop",
  "scope": "world-local",        // default
  "reason_code": "VAL_FAIL"
}
```

---

## 17) 마이그레이션 가이드(요지)

1. 기존 “노드-월드 통합 테이블”이 있다면 **전역(GSG)과 월드(WVG) 스토어로 분리**.
2. 모든 결정 이벤트에 **`scope` 기본값 주입**(world-local).
3. `EvalKey` 계산 경로에 **DatasetFingerprint/ContractID** 추가.
4. 대시보드: 전역 페이지에서 **월드별 상태를 병렬 카드**로 표시(합산 색칠 금지).

---

이 구조를 채택하면, **전역 중복 제거**와 **월드별 유효성 독립성**을 모두 만족하면서도, 개념 수를 3개(GSG/World/Eval)까지 줄여 **온보딩 비용을 낮출 수 있습니다**. 필요하시면 위 문구들을 마크다운/스펙 문서 형식에 맞춰 바로 넣을 수 있게 재포맷해서 드릴게요.
