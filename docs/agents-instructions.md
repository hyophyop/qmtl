# Agent Instructions

This file is auto-generated by `scripts/build_agent_instructions.py`.

## AGENTS.md (scope: repository root)

# Development Guidelines

This repository hosts strategy experiments built on top of the [QMTL](qmtl/README.md) subtree. For comprehensive policies—such as the QMTL subtree workflow, testing commands, and the AlphaDocs process—see [CONTRIBUTING.md](CONTRIBUTING.md).

Key reminders:

- Always synchronize the `qmtl/` subtree before starting work and push upstream after making changes.
- Strategy-specific code lives under `strategies/`; keep reusable utilities only in `qmtl/`.
  - Exception: thin, strategy-local convenience wrappers (e.g., lightweight shims under `strategies/utils/`) are acceptable when they adapt QMTL APIs for strategy ergonomics. Promote broadly reusable helpers to `qmtl/` via the subtree process.
- When implementing a strategy, deliver both the core logic and a QMTL node that consumes it so it can be used in DAGs. Place node processors under `strategies/<strategy>/nodes/` and follow naming/I-O conventions in `strategies/AGENTS.md`.
- When modifying the subtree itself, follow `qmtl/AGENTS.md`. For strategy conventions, refer to `strategies/AGENTS.md`.
- If any `AGENTS.md` files change, run `uv run python scripts/build_agent_instructions.py` to refresh `docs/agents-instructions.md` before committing. CI already runs this when relevant, so running it locally avoids surprises.

Terminology note: follow the repository’s terminology style guide in `CONTRIBUTING.md` (DAG, AlphaDocs vs `docs/alphadocs/`, Strategy vs strategy, etc.).

Automation helpers

- A pair of helper scripts are provided under `scripts/` to standardize common tasks:
	- `scripts/bootstrap.sh` — create `uv` venv, install editable `qmtl[dev]` deps and run a fast smoke test (strategies tests if present).
	- `scripts/sync_qmtl.sh` — fetch and pull the `qmtl` subtree from the `qmtl-subtree` remote and print recent commits for verification.

Please run `scripts/bootstrap.sh` when setting up a dev environment. Note: bootstrap performs a minimal setup and a quick smoke test; if you use pre-commit locally, also install and enable hooks with `uv run pre-commit install`. If you modify any files under `qmtl/`, run `scripts/sync_qmtl.sh` to pull upstream changes before making edits and follow subtree push instructions when pushing changes back upstream.

CI / Docs triggers

- The CI workflow will run the agent docs build step when `AGENTS.md` changes. If you update `AGENTS.md`, ensure `docs/agents-instructions.md` is refreshed by running (the builder scans the entire repo for `AGENTS.md` files):

```bash
uv run python scripts/build_agent_instructions.py
```

This repository's maintainers aim to keep the doc build step in CI to prevent stale agent instructions.

## qmtl/AGENTS.md (scope: qmtl subtree)

# Development Guidelines

**Applies to files under `qmtl/`.**

For general contribution and testing policies, see the repository root [AGENTS.md](../AGENTS.md).

## Environment

- Manage the Python environment using **uv**. Install dependencies with
  `uv pip install -e .[dev]` and build distributable wheels via `uv pip wheel .`.
- When a task needs GitHub access (issues, PRs, metadata), use the `gh` CLI commands instead of manual web actions.

## Architecture

- Implementations must adhere to the specifications in `docs/architecture/architecture.md`,
  `docs/architecture/gateway.md` and `docs/architecture/dag-manager.md`.
- Do not place alpha or strategy modules in `qmtl/`; only reusable feature extraction or
  data-processing utilities belong here. All alpha logic should live in the root project's
  `strategies/` directory.

## Documentation Management

- Store documentation in the `docs/` directory with descriptive filenames.
- Each Markdown file should start with a single `#` heading and use relative links to other docs.
- Update `mkdocs.yml` navigation when adding or moving files.
- Validate docs with `uv run mkdocs build` before committing. Ensure `mkdocs-macros-plugin`
  and `mkdocs-breadcrumbs-plugin` are installed via `uv pip install -e .[dev]`.
- Diagrams: Use Mermaid fenced code blocks (```mermaid) for all diagrams. Avoid PlantUML/DOT or binary diagram files; prefer text-based Mermaid for reviewability and versioning.

## Testing

- Always run tests in parallel with `pytest-xdist` for faster feedback:
  `uv run -m pytest -W error -n auto`
- If `pytest-xdist` is not installed, add it temporarily with
  `uv pip install pytest-xdist` (or add it to your local extras).
- For suites with shared resources, prefer `--dist loadscope` or cap workers
  (e.g., `-n 2`). Mark must‑be‑serial tests and run them separately.

### Hang Detection Preflight (required in CI and recommended locally)

To prevent a single hanging test from blocking the entire suite, we run a fast
"preflight" that auto‑fails long runners before the full test job:

- Quick hang scan (no install step needed in CI/local):
  - `PYTHONFAULTHANDLER=1 uv run --with pytest-timeout -m pytest -q --timeout=60 --timeout-method=thread --maxfail=1`
  - Rationale: `pytest-timeout` turns hangs into failures with a traceback; `faulthandler` ensures a stack dump is emitted.
- Optional: collection sanity check to catch import‑time blocks early:
  - `uv run -m pytest --collect-only -q`
- After preflight passes, run the full suite:
  - `uv run -m pytest -W error -n auto`

Guidance for authors:
- If a test is expected to exceed 60s, add a per‑test timeout override: `@pytest.mark.timeout(180)`.
- Mark intentionally long or external‑dependency tests as `slow` and exclude them from preflight via `-k 'not slow'` if necessary.
- Prefer deterministic, dependency‑free tests; avoid unbounded network waits.

## Example Projects

Example strategies under `qmtl/examples/` follow the same conventions as the rest of the
project:

- Run tests with `uv run -m pytest -W error -n auto`.
- Place node processors under `nodes/` and tests under `tests/`.
- Keep functions pure and free of side effects.

## Issue & PR Linking

- When work starts from a GitHub issue, include a closing keyword in both your final result message and the PR description so the issue auto‑closes on merge.
- Use one of: `Fixes #<number>`, `Closes #<number>`, or `Resolves #<number>` (e.g., `Fixes #123`).
- If referencing multiple issues, list each on its own line.
- For cross-repo issues, use `owner/repo#<number>` (e.g., `openai/qmtl#123`).
- If the change is partial and should not close the issue, prefer `Refs #<number>` instead of a closing keyword.
- Prefer placing the closing keyword in the PR body; commit messages on the default branch also work but are less visible.

Example PR snippet:

```
Summary: Implement data loader fallback path

Fixes #123
Also Refs #119 for broader tracking
```

## strategies/AGENTS.md (scope: strategies directory)

# Strategy Guidelines

These guidelines apply to all files under the `strategies/` directory. General repository setup and testing rules are described in the root [AGENTS.md](../AGENTS.md).

## Setup

Follow the instructions in the root `AGENTS.md` to set up the environment and run tests. No strategy-specific setup is required.

## Development

- Implement node processors as pure functions under `nodes/` so they can be reused across DAGs.
- Define strategy DAGs in `dags/` using `qmtl.dag_manager` for orchestration.
- Connect nodes by wiring explicit output keys to input parameters; the graph must remain acyclic and each node name unique.
- Use `snake_case` for file and function names. Name node processor functions with the `_node` suffix and DAG modules with the `_dag.py` suffix.

## Testing

- Add tests for strategy behavior under `strategies/tests/`.
- Run the repository's test suite from the project root as documented in the root `AGENTS.md`.

